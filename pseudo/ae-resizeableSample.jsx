explainerVideoToolkit(this);

function explainerVideoToolkit(thisObj) {

	var scriptName = "Explainer Video Toolkit";
	var scriptVersion = "3.5";

	// Generate Object List
		var objectList = 
		[]

	// Initialise iamges for UI
		var userDataFolder 	= getUserDataFolder();
		var logoRegularBin 	= ["\u0089PNG\r\n\x1A\n\x00\x00\x00\rIHDR\x00\x00\x00\u0093\x00\x00\x00\x14\b\x06\x00\x00\x00\u0089P\x0Fu\x00\x00\x00\tpHYs\x00\x00\x00\x01\x00\x00\x00\x01\x018\"\u00F4@\x00\x00\x00$zTXtCreator\x00\x00x\u009CsL\u00C9OJUpL+I-RpMKKM.)\x06\x00Az\x06\u00CE\u00E7\u00CDsf\x00\x00\x07[IDATh\u0081\u00ED\u0099m\u008C\u0095G\x15\u00C7\x7Fg\u00B1\u00B0 om\u0081\u00A5\u00DA\u00C866\x04\x0BV\u00D0\u00CA\x16\\\u00C3\u00FA\u00C166\u00B6A\u00FA\u00A1\u00A4j\u0083\u00C4\u0098&6VCj\u00B0\x1AKH\u00B5U[C\u00AC\u00D24\u00F6\x03\u00B1\u0098\u0082/-F\u00D0\u00A2%](\u0085X\x14\x0BA^d[i+\u00DB\u0085\u00D2\u0082\u00BAV\u00CA\u00B2\u00FB\u00F7\u00C39\u00B3;<\u00FB\u00DC\u00CB\u00A5K\u00D4\u00C4\u00FBOnf\u00E6\u009C3\u00E7\u009C\u0099g\u00E6\u00CC\u0099\u00B9PG\x1Du\u00D4QG\x1Du\u009C+$].\u00A9]\u00D2\u00FA\x1Ad\u0097\u0086\u00EC\u00A2\u00FF\u0080k\u00D5\u00FCX\x14~,-\u00E1M\x0E^\u00FB\x7F\u00C1\u00B5sB\u00F23|Nc\u00BA\u00BBD\u00AE5x\x0F\u009F\u00A3\u00FEI\u0092\u009A%\r\u00CB\u00E9\r\u00C1\u00FC\u00A2\u00CAqh\bc\x1A\r\u00CC\x03Zk\u0090\u009D\x004\x03\u00E3\u0087`\u00AF*$-\u008C1u\x16\u00E8?\x0E\u00FACa\u00BF9\u00FC)\u00A2\x11\x1F\u00CF\u00BC\u00F3\u00E8\u00D3\u00BA\n\u00F3.ImCP\u009D\u00FCl\u00C4\u00C73\x0F\u0098Q\"7*\u00F8\u00EF\b\x7F&Kj\u00934\u00B3\u0082\u00BF\x13%=\t\x1C\x01\u00FE\x02tJ\u00BA\u00A1(\u0094\x16\u00D3\u00B1lU\u00B7KZ\u00F3VG#if\u00E8<\u00F1Vu\u009COH\u00BAXR_\u00F8\u00F4\u00AE\u008C\u00FEB\u00D0\x16\u009C\u00A5\x7Fs\u00FA\u00CA\u00E7\u00D1\u00A7\u00BBc\u009E\u00F7\u0084\u00EA\u00EEl\u00EEK?h\u008Dz\x13\u009A%-\u008B\u00FA\u00BA\x1A\u00FA-\n\u00D9\u00F6\n\u00FCG\u0082\u00DF!i}\u00D4\u00FF%i\x02\u00C0\u00DB\n\u00F2[\u00CDl~A\u00C1\f|\u00A7\u00BEnf\u00BB%\u00CD\x02\u00C6\x01G\u0081S\u00C0\u00A5\u00C0\u00F3\u00C0\u00FB\u0082\u00FEK3\u00FB{\x05g\u00C6\x03\u00D7\x00c\u00C2\u00D6\u0081\u00A0O\x03&\x03\u0087\u0080.\u00E0j\u00E0$\u00B0\x0F\u00B8\x1E\u00E82\u00B3'3=c\u0081\u008F\x01o\x076\u0099\u00D9\u008BAo\u008D1\u00ED\x07\u00AE\x03\x1E1\u00B3\x1E\x003{M\u00D2\x0E`60\x07xIR\x13p\x19\u00D0\x0Bl\u0092\u00D4\u008C\u00EF\u00D4.3\u00DB\x1F:g\u00E3\u00BBz_\u00C9x\x1A\u00C3\u008F\u008B\u0081mf\u00B67\u00E3\u008D\x03\u00AE\u008D\u00B1n\u00CFy\tf\u00F6\u00B5\u0090\u009D\x0F<\x0Et\u0098Y[\u00A6cd\u00E8\u0098\x00\u00EC2\u00B3\x1D\x05\u00FB\x1F\x06\u00A6\u00E2\u0091bc\x1Ak5Hz?0\x168\u0086\u00CF\u00F5\f\u00A0\x1B\u009F\u00FBi!6^\u00D2Uf\u00F6\u00FBB\u00F7\u008B\u0080]\u00C0\u00E7\u0081m\u00C0K\u00F8\u00F7o\x016$\x03)2\rZ\u00BD\u00D9j=*i\u0094\u00A4\u00BFE{\u00A1\u00A4\x15Q?\u0092\u00ED\u0086\x03\u0092\u00C6\x14#\u0093\u00A4\u00F7\u0084\u008E\u0084^E\u008E$iU\u00D0\u0096e\x11\u00E0\u0084\u00A4\u00DD\u0099\u00FC\u00ED!;E\u00D2\u00CB\x19\u00FDMI\x1F\r\u00DE\u0089\u00A0\u00ED\u0095\u00D4#\u00A9\u00A10\u0096\u00E5\u00C1_\u0091>b\u00B4\u00B7D;\u00ED\u00E2U\u00D1\u00FETf'\u008D[\u00C1\x1B/iW\u00C6\u00EF\u0093\u00B48x\u00D3$u\u00E9L,\u00A9\u00F2\u0081\u0093\x1F\u00CFe\u00B4&\u00F9\\\u00E6x x&iu\u0081\u00F7\u009C|\x01W\u008CL\u00F2\\\u00E7d\u00B4o\u00CA\u00EDf\u00F5~}\u0095\u00FC\r\x1B\r\u0092:C\u00B6\x15\"g\u00CA\u00D0\x12F\u00D3o\x06\u00B0\x1A\u008F<\x13\u0081e\u00F8\u00AA\u00DE\x07\u00FC$\u00EB\u00D7\r,\x06\x0E\u00E3;\u00E5\u00B3%\u00F6\u0097\u0086\u008EG\u0081\u00E5a\u00FB\u009BU\u00FC\x1D\x07\u00AC\x05~\x16\u00EDEQ~\x0B\u00DF\r\u00EB\u0081\u00EF\x00\u00C3\u00A3\u00CCq\x01\x1E\u0095\u00FA\n\u00F4'\u00A2\u009CS(\x7FS4.\u00C9\u0080{\u00A3\u00F9\x03\u00A0x\u00E4\x7F\x19\u00B8\x12\u00D8\x01\u00DC\x01\x18p\u00BF\u00A4\x0B\u0080\u00EF\x01M\u00C0c\u00C0\u0097\u0080>\u00E0\u00DB\u0092\u00A6T\x1C\u00ED`,\u00C7\u00E7\u00F2i\u00E0s\u00F8\x1C\u00DF&\u008FF7\x00\u009F\x04^\u00C5\u00E7z'~2|\u00E5,:o\x03F\x00O\u009B\u00D9\u00DA\x02\u00EFw\u00C0\x03Q\u00FFS\u00F8]\nI\u00F7\x00\x1B\u0081K\u0080-x\u0094\u00EAgVJ\u00C0\u00DB\u0082\u009F\u00A2So\u0094\x0B\u0083\u009E\"S\u00DA\u00E9\u00F7F{\u008D\x06G\u00A6\u00CB\u0082v\u0091\u00A4w'\x03\u00C1+\u008BL\u0089\u00D7\x1A\u00CD\u00A3\u00D1NQ\u00F0\u00DA\u00D0\u00990R\x03\u0091iv\u0085I\x18&\u00E9\u00B8\u00A4S\u0092\x1A%m\t\u00F9\x0F\x04\u00BF?2\u00C9o\u00A3\u0092tZ\u00D2\u00E8\x12\u00BF\u00B6G\u00F3Vy\u0094z-\u00DAW\u00CA\u00A3\u00A2$M\x0F\u00D9g\u00A3\u00FD\u0099\n~\u0095E\u00A6\u0083A\u00FBx\u00B4\u00D7D{\u00B9\u00A4\u00EFG}e\u00F0>\x1D\u00ED\x1D\u00D1N\u00C8#\u00D33\u0092^\u0095G\u00D0\u0099evu\u0096\u009C)\u00F3\u00EDDf\u00A3?\u00E2\x16#\u00D3\u00AF\u0080\x0B\u00B3\u00DF\u00D6\u00A0\u00AF\u00C6s\u00A4\x06\u00E0e\u00CE\u008CJ9\u00BA\u00A2l,\u00E1\u00F5\u00E1Q\u00E5\x05\u00A0\u00A3\u009A\u00B3\x05tG9<\u00CAIQ>\x11\u00BA\x12Fd\u00F5Se\u008A\u00CC\u00AC\x17\u00D8\u0084G\u00AE\x16\u00E0\u0083\u00F8\u00EE\u00FEc\u0089\u00F8%Q\x1E7\u00B3\u00EE\x12~\u00F2\u00E3A\u00E08\u009EO\u0080G\u00D4\u0094\u008B\u00A6\u009B\u00E3+\x19\u00AFVL,\u00E8Hs;\x16\u00BF)\u0083\x7F\u0093\\\x7F\u00EAS\u0086\u00B9x\u00EEu\x10\u00CF{\u0086\u0082)\u00C0U\u00F8\u00B8\u00EFK\u009B\u00B7\u0098\u0080\u00F7\u0098Y\u00D9\u00ED\u00EB\u00BD\fL\u00DE\u00A5x\u00A26(\u00A1\x04\u0086\u0095\u00D0\x12\x1E\u00C2\u0093\u00EFUx\u0088|\u00B4V\u00CF\u008B>\u00E2\u008B\u00E1.<\x01Lx\u00A3\u00C6\u00FE\u00BF\x06n\u00C4\u0093\u00C8F\u00E0\u00E7%\u00C7a\u00B2\x03g.\u00D2\x1Ci\u00C1\u00AE\u00C4\u008F\u00BA\u0084|\u0081\u008F\u00C4'<m\u00AE\u00DE\x1A}\x04x3\u00D3A\u00A6\u00A3\x0FH7\u00CA\u00E1\x05\u0099\u0093U\u00F4\u00ED\u00C17\u00C8T\u00E0&\x06\x1F\u00DBg\u0085\x06\u009E+\u00B6\u009B\u00D9\x1F$m\u00C7/:-\u00C0\u00B3\u00C5\u00C8T\twE\u00F9\f\u009E\x1B|\u00BD\u00C0\u00BF0\u00CAt\u00BC\x1C)\u00D115\u00CA\u009F\u0092\u00DD\u008CTx\u00F8\u00AA\x01)\u00AA\u009D2\u00B3U\u00C0:`\u00A7\u0099\u0095F\u00A3\x12l\u008C\u00F2\x13Q\x0E\u00CA\u0097\x02\x07\u00F1\u008F6F\u00D2\x15\u00F8\u008D\u00AD\u00CC\u008F\x11\u00E1\u00C7Z`\u00AF\u0099\x1D\u00C6sG\u0080\u00B9\u0092F\x01\u00B3\u00A2}\u00A0F\x1Fs\u00D991GWG{\x7F\u00C6k\u0091\u00E7v\x1F\u008A\u00F6\u009F\u00AB\u00E8{\x1E\u00B8/\u00EA\u00F7H\x1A^\"\u0093\x16\u00FB\u00A8\n:6\x00O\x01\u00D7\u00C5\u00B8\u00A6\x07\u00FD\x1F\u00FD\x12\u00AA\u00F2h)iV\u00D4{\u00E4yDO\u009C\u00BB\u00B34\u00903)\u00CE\u00E3\u00846\r\u00CE\u00996D\u00BBK\u00FE\u009E\u0095\u00D0\u00A4\u00EA9SQ\u00CF-Y\u00DFNy\u00FE\u00B35x\u00E9,\u00AF\u00FAF\u00A3\u0081w\x1DI\u009A\u0094\u00D1\u008B\u00B7\u00B9\u00E4\u00F3\x1B\x1A\u00B8\x05%\u00BF\u00E6i \u0087<\"\x7Fo9,\u00CF\u00CB\u0096\x04\u00FDt\u00E6\u00D3nI\u00C5\u0093 \u00D9-\u00CB\u0099\x16\x04\u00ADO\u00D2\u00EBQ\x7FE\u009E\u009FM\u0096\u00E7~*\u00CC\u00E5G\u00A2oB\u00F167:\u0093_R\u00B4+in\u00D6w\u00D0\u00C9#ie\u00F0z2\u00FB\u0087\u00E5O>\u00FD\u00C7\u00DC_\u0081\u00CD%\u00E3\u00EC\u00C2\u008F\u00A6\u00CD\u00C0n3\u00EB\u0090\u00F4 ~\u008B\u00B9&\u0093\u00FB-\u00FE\u00E6\u00D3\t\u00AC4\u00B3vI\u0097G\u00BF\u0094o|\x01\u008Fj\u00CD\u00F8\u00ED\u00EBz<\u00CFx'\u00BE\u00DB6\u00E3o\x1D'\x0B\u00BEt\u00E7z\u00CC\u00ECG\u00F1=o\u00C5s\u0084\u009D\u00C0\u008A\u0090\u00DD\u008A\u00E7\x13e9N\u008E\u0087\u0081\u00F9\u00C0\u008Bfv4\u00A3\x1F\n[\u00FB\u00A3\u00BD\x18\u00CF\u0089\u00A6G\u009F\x16\u00E2u\u00DC\u00CC6\u00CB\u0093\u00E3;\u00F0\x1Cb\x0F\u00F0C3\u00EB\u0095\u00F4]\u00FC\u0098\u00BC\x05\x7Fgz\x1C\u00F8\u00AA\u0099\u009D\u00AE\u00E0\u00CF\u00B1\u00B0\u00DB\u009FK\u009A\u00D9c\u0092n\u00C6\u008F\u00E3&<\"\u00DC\u0099\u00D2\u0090X8\u00CB\u0081+\u00C2\u00F6\u00FDf\u00F6TtO\u00F3w2\x1B\u00D3\x1E3\u00EB\u0096t'p3\u00FE\u00CF\u00C4\u008E\u00DC\u00AE\u0099m\u0093\u00F4\r`\x01\u00F0OI\r\u0085\x14\u00E0v\u00FC\x1B\u00DF\u0088G\u00AF_\x00\u00CB*\u00A4F\u00E7\x06\x15nsu\u00FC\x7F\u00A3\u00D6\u009C\u00A9\u008E:\u00CE\u008A\u00A1.\u00A6\x0E\n\u00E1\u00B9\u008E:\u00EA\u00A8\u00A3\u008E:\u00FEw\u00F0o\u00B3\u00A3\u00D4\u008C.jO\n\x00\x00\x00\x00IEND\u00AEB`\u0082"];

		var logoRegularPath = createResourceFile ("EVT3 Logo 1.png", logoRegularBin, userDataFolder);

	// Build UI;
		var scriptPalette = scriptBuildUI(thisObj);
		if ((scriptPalette != null) && (scriptPalette instanceof Window)) {
			scriptPalette.center();
			scriptPalette.show();
		} else {
			scriptPalette.layout.layout(true);
		}

		function scriptBuildUI(thisObj) {
			var win = (thisObj instanceof Panel) ? thisObj : new Window("palette", scriptName + " v" + scriptVersion, undefined, {resizeable:true});
				win.spacing = 2;

				var grpHeader = win.add("group");
					grpHeader.alignment = ["fill", "top"];
					grpHeader.spacing = 2;

					var imgLogo = grpHeader.add("image", undefined, logoRegularPath);
						imgLogo.alignment = ["Left", "top"];
						imgLogo.helpTip = "Visit renderTom.com for more information";


				var grpContainer = win.add("group");
					grpContainer.orientation = "column";
					grpContainer.spacing = 2;
					grpContainer.alignment = ["fill", "fill"];

					var grpSearch = grpContainer.add("group");
						grpSearch.spacing = 2;
						grpSearch.alignment = ["fill", "top"];

							var searchField = grpSearch.add("edittext", undefined, "");
								searchField.alignment = ["fill", "fill"];

							var btnResetSearch = grpSearch.add("button", undefined, "x");
								btnResetSearch.alignment = ["right", "fill"];
								btnResetSearch.size = [22, 22];

					var myTree = grpContainer.add("treeview", undefined, [], {multiSelect:true});
						generateTree(myTree, objectList, false);
						myTree.alignment = ["fill", "fill"];
						myTree.preferredSize = [150,300];


			// Button Actions
				btnResetSearch.onClick = function() {
					searchField.text = "";
					myTree.removeAll();
					generateTree(myTree, objectList, false);
				}

				var timer = null;
				searchField.onChanging = function() {
					if (typeof app.setTimeout === "undefined") { filterIt(); }
					else {
						if (timer !== null) app.cancelTimeout(timer);
						timer = app.setTimeout(filterIt, 300);
					}

					function filterIt() {
						var filteredItems = findItems(objectList, searchField.text.toLowerCase());
						myTree.removeAll();
						generateTree(myTree, filteredItems, searchField.text !== "");
					}
				}

				if (parseInt(app.version) === 11) {
					myTree.addEventListener("mousedown", function(e) {
						if (e.detail == 2)
							executeFunction();
					});
				} else {
					myTree.onDoubleClick = function () {
						executeFunction();
					}
				}

				function executeFunction() {
					var curSelection = myTree.selection;
						curSelection.expanded = !curSelection.expanded;
					if (curSelection.myData) {
						try {
							eval(curSelection.myData.functionName);
							writeLn(curSelection.myData.name + ". Done.");
						} catch (err) {
							alert(err.name + "\nLine: " + err.line.toString() + "\nMessage: " + err.message);
						}
					}
				}

			win.onResizing = win.onResize = function () {this.layout.resize();};

			return win;
		}

	// Other functions
		function generateTree(treeObject, myObject, expanded) {
			for (var i = 0; i < myObject.length; i ++) {
				if (myObject[i].items) {
					var myNode = treeObject.add("node", File.decode(myObject[i].name));
					generateTree(myNode, myObject[i].items, expanded);
					myNode.expanded = expanded;
				} else {
					var myItem = treeObject.add("item", File.decode(myObject[i].name));
					myItem.myData = myObject[i];
				}
			}
		}

		function findItems(myObject, inputString){
			var newObject = [];
			for (var i = 0, il = myObject.length; i < il; i ++) {
				if (myObject[i].items) {
					var itemsList = findItems(myObject[i].items, inputString);
					if (itemsList.length > 0) {
						var newNode = {name : myObject[i].name, items : itemsList, functionName : myObject[i].functionName};
						newObject.push(newNode);
					}
				} else {
					if (myObject[i]["name"].toLowerCase().match(inputString)) {
						newObject.push(myObject[i]);
					}
				}
			}
			return newObject;
		}

		function openURL(URL) {
			try {
				if (URL.match(/^http:\/\//) === null) URL = "http://" + URL;
				if ($.os.indexOf("Windows") != -1) 	system.callSystem("cmd /c \"explorer " + URL);
				else 								system.callSystem("open " + URL);
			} catch(err){
				alert("Error in openURL function\n" + err.toString());
			}
		}

		function switchUIImage(element, newImg) {
			if (parseFloat(app.version) > 11)
				element.icon = ScriptUI.newImage(newImg);
		}

		function getUserDataFolder () {
			try {
				var userDataFolder = Folder.userData;
				var aescriptsFolder = Folder(userDataFolder.toString() + "/FredyV/" + scriptName + " v" + scriptVersion);
				if (!aescriptsFolder.exists) {
					var checkFolder = aescriptsFolder.create();
					if (!checkFolder) {
						alert ("Error creating \"" + checkFolder.fsName + "\nPlease check the permissions for this folder:\n" + userDataFolder + "\n\nA temp folder will be used instead");
						aescriptsFolder = Folder.temp;
					}
				}
				return aescriptsFolder.toString();
			} catch(err) {
				alert("Permissions issue with user data folder\nPlease give AE full read and write permissions to the ~/Library/Application Support/" + "FredyV" + " folder. ");
			}
		}

		function createResourceFile (filename, binaryString, resourceFolder) {
			try {
				var myFile = new File(resourceFolder + "/" + filename);
				if (!File(myFile).exists) {
					if (!(isSecurityPrefSet())) {
						alert ("This script requires access to write files.\n" +
						"Go to the \"General\" panel of the application preferences and make sure\n" +
						"\"Allow Scripts to Write Files and Access Network\" is checked.");
						app.executeCommand(2359);
						if (!isSecurityPrefSet()) return null;
					}
					myFile.encoding = "BINARY";
					myFile.open( "w" );
					myFile.write( binaryString );
					myFile.close();
				}
				return myFile;
			} catch(err){
				alert("Error in createResourceFile function\n" + err.toString());
			}
		}

		function isSecurityPrefSet(){
			try {
				var securitySetting = app.preferences.getPrefAsLong("Main Pref Section", "Pref_SCRIPTING_FILE_NETWORK_SECURITY");
				return (securitySetting == 1);
			} catch(err){
				alert("Error in isSecurityPrefSet function\n" + err.toString());
			}
		}

}